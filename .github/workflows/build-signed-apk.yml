name: Build Signed APK

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle
      
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      
      - name: Generate Release Keystore
        run: |
          keytool -genkey -v -keystore app/release-keystore.jks \
            -keyalg RSA -keysize 2048 -validity 10000 \
            -alias nobook-key \
            -storepass android123 \
            -keypass android123 \
            -dname "CN=Nobook, OU=Development, O=Nobook, L=Unknown, ST=Unknown, C=US"
      
      - name: Build Release APK
        env:
          KEYSTORE_PASSWORD: android123
          KEY_ALIAS: nobook-key
          KEY_PASSWORD: android123
        run: ./gradlew assembleRelease --stacktrace
      
      - name: Verify APK Signature
        run: |
          APK_PATH=$(find app/build/outputs/apk/release -name "*.apk" | head -n 1)
          if [ -f "$APK_PATH" ]; then
            echo "APK encontrada: $APK_PATH"
            jarsigner -verify -verbose -certs "$APK_PATH"
          else
            echo "No se encontrÃ³ la APK"
            exit 1
          fi
      
      - name: Rename APK
        run: |
          cd app/build/outputs/apk/release
          APK_FILE=$(ls *.apk | head -n 1)
          mv "$APK_FILE" "Nobook-v${{ github.run_number }}-signed.apk"
      
      - name: Upload Signed APK
        uses: actions/upload-artifact@v4
        with:
          name: nobook-signed-apk-v${{ github.run_number }}
          path: app/build/outputs/apk/release/Nobook-v${{ github.run_number }}-signed.apk
          retention-days: 30
      
      - name: Upload APK Summary
        run: |
          APK_PATH="app/build/outputs/apk/release/Nobook-v${{ github.run_number }}-signed.apk"
          APK_SIZE=$(du -h "$APK_PATH" | cut -f1)
          echo "### ðŸ“¦ APK Firmada Generada" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Nombre**: Nobook-v${{ github.run_number }}-signed.apk" >> $GITHUB_STEP_SUMMARY
          echo "- **TamaÃ±o**: $APK_SIZE" >> $GITHUB_STEP_SUMMARY
          echo "- **Build**: #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
